# Ansible Configuration for Kubernetes Cluster

Automated Kubernetes cluster setup with optimized playbooks for parallel execution.

## Structure

```
ansible/
├── playbooks/          # Execution order: 00→01→02→03→04
│   ├── 00-Prerequisites.yml         # Python dependencies (all nodes)
│   ├── 01-Configure-nodes.yml       # System prep, containerd, k8s
│   ├── 02-Initialize-control-plane.yml  # kubeadm init, CNI
│   ├── 03-Join-worker-nodes.yml     # Join workers
│   ├── 04-Ddeploy-infra.yml         # Infrastructure services
│   └── 999-Destroy.yml              # Cluster cleanup
├── roles/              # Reusable components
│   ├── firewall, system-prep, container-runtime, kubernetes, networking
│   ├── metric-server, gateway-api, istio, metallb, cert-manager
│   └── nfs-provisioner, seaweedfs, vault, argocd
├── group_vars/
│   ├── all.yml                      # Generated by Terraform
│   └── vault.yml.example
└── ansible.cfg                      # Optimized: forks=20, strategy=free
```

## Optimizations Applied

**Parallelization:**
- `strategy: free` - Nodes execute independently
- `forks: 20` - Up to 20 parallel operations
- Grouped infrastructure deployment for logical ordering

**Performance:**
- `cache_valid_time: 3600` - APT cache reuse
- Fact caching enabled (24h TTL)
- SSH pipelining and ControlPersist

**Reliability:**
- Improved wait conditions with defensive checks
- Better retry logic (30 retries for k8s resources)
- Enhanced idempotency checks

## Quick Start

```bash
cd ansible

# Run all playbooks in sequence
ansible-playbook playbooks/00-Prerequisites.yml
ansible-playbook playbooks/01-Configure-nodes.yml
ansible-playbook playbooks/02-Initialize-control-plane.yml
ansible-playbook playbooks/03-Join-worker-nodes.yml
ansible-playbook playbooks/04-Ddeploy-infra.yml

# Clean cluster
ansible-playbook playbooks/999-Destroy.yml
```

## Configuration

**Ansible Vault:**
```bash
cp group_vars/vault.yml.example group_vars/vault.yml
ansible-vault edit group_vars/vault.yml
# Use --ask-vault-pass when running playbooks
```

**Key Variables** (in `group_vars/all.yml`):
- `kubernetes_version`, `calico_version`, `istio_version`
- `pod_network_cidr`, `desired_dns_servers`
- `metallb_ip_range`, `git_repo_url`

## Common Commands

```bash
# Test connectivity
ansible all -m ping

# Syntax check
ansible-playbook playbooks/*.yml --syntax-check

# Dry run
ansible-playbook playbooks/01-Configure-nodes.yml --check

# Debug
ansible-playbook playbooks/01-Configure-nodes.yml -vvv
```

## Infrastructure Deployment Stages

**04-Ddeploy-infra.yml** runs in 6 sequential phases respecting dependencies:

1. **Base:** metric-server, metallb, cert-manager (no dependencies)
2. **Gateway API CRDs:** Must be installed before Istio
3. **Service Mesh:** istio, default-gateways (requires Gateway API)
4. **Storage Provisioner:** nfs-provisioner (no dependencies)
5. **Object Storage:** seaweedfs (requires NFS for volume backend)
6. **Secrets Management:** vault (requires SeaweedFS for S3 backend)

**Dependency Chain:**
- Gateway API → Istio (Istio uses Gateway API CRDs)
- NFS → SeaweedFS (SeaweedFS volumes use `storageClassName: nfs-client`)
- SeaweedFS → Vault (Vault uses SeaweedFS S3 endpoint)

## Roles

**Node Setup:**
- `firewall` - UFW rules for K8s, Calico, NFS
- `system-prep` - Disable swap, kernel modules, sysctl
- `container-runtime` - containerd installation & config
- `kubernetes` - kubeadm, kubelet, kubectl
- `networking` - Network fixes for Calico VXLAN

**Infrastructure:**
- `metric-server` - Cluster metrics
- `gateway-api` - Kubernetes Gateway API
- `istio` - Service mesh (ambient mode)
- `metallb` - LoadBalancer service support
- `cert-manager` - TLS certificate management
- `nfs-provisioner` - Dynamic NFS storage
- `seaweedfs` - S3-compatible object storage
- `vault` - Secrets management
- `argocd` - GitOps deployment

## Files

- `hosts.ini`, `group_vars/all.yml` - Auto-generated by Terraform
- `ansible.cfg` - Performance tuning, SSH config
- `templates/kubeadm-config.yml.j2` - Cluster initialization template
