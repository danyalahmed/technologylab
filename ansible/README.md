# Ansible Configuration for Kubernetes Cluster

Automated Kubernetes cluster configuration using Ansible playbooks and roles.

## Directory Structure

```
ansible/
├── playbooks/          # Ansible playbooks (executed in order)
│   ├── 00-install-python-deps.yml    # Install Python dependencies
│   ├── 01-prepare-nodes.yml          # Prepare all nodes
│   ├── 02-init-controlplane.yml      # Initialize control plane
│   ├── 03-join-workers.yml           # Join worker nodes
│   ├── 04-bootstrap-argocd.yml       # Bootstrap ArgoCD
│   └── 999-cleanup.yml               # Cleanup cluster
├── roles/             # Reusable Ansible roles
│   ├── firewall/                     # UFW firewall configuration
│   ├── system-prep/                  # System preparation
│   ├── container-runtime/            # Containerd installation
│   ├── kubernetes/                   # Kubernetes components
│   └── networking/                   # Network fixes
├── templates/         # Jinja2 templates
│   ├── inventory.tftpl               # Inventory template
│   └── kubeadm-config.yml.j2         # Kubeadm config template
├── group_vars/        # Group variables
│   ├── all.yml                       # Auto-generated by Terraform
│   └── vault.yml.example             # Vault example
├── ansible.cfg        # Ansible configuration
└── hosts.ini          # Inventory file (auto-generated by Terraform)
```

## Auto-Generated Files

The following files are automatically generated by Terraform:
- `hosts.ini` - Ansible inventory with control plane and worker IPs
- `group_vars/all.yml` - Variables including versions and network configuration

## Playbook Execution Order

### Automatic Execution (via Terraform)

When `auto_run_ansible = true` in Terraform:
1. VMs are created
2. Playbooks run automatically in sequence
3. Cluster is ready when Terraform completes

### Manual Execution

```bash
cd ansible

# 1. Install Python dependencies
ansible-playbook -i hosts.ini playbooks/00-install-python-deps.yml

# 2. Prepare all nodes
ansible-playbook -i hosts.ini playbooks/01-prepare-nodes.yml

# 3. Initialize control plane
ansible-playbook -i hosts.ini playbooks/02-init-controlplane.yml

# 4. Join worker nodes
ansible-playbook -i hosts.ini playbooks/03-join-workers.yml

# 5. Bootstrap ArgoCD
ansible-playbook -i hosts.ini playbooks/04-bootstrap-argocd.yml
```

## Ansible Roles

### firewall
Configures UFW firewall rules for Kubernetes:
- SSH access
- Kubernetes API server (6443)
- etcd (2379-2380)
- Kubelet API (10250)
- Calico networking (BGP, VXLAN)
- NodePort services (30000-32767)

### system-prep
Prepares the system for Kubernetes:
- Disables swap
- Loads kernel modules (overlay, br_netfilter)
- Configures sysctl parameters
- Enables IP forwarding

### container-runtime
Installs and configures containerd:
- Installs containerd package
- Generates default configuration
- Enables SystemdCgroup
- Starts containerd service

### kubernetes
Installs Kubernetes components:
- Adds Kubernetes APT repository
- Installs kubeadm, kubelet, kubectl
- Holds packages at current version
- Enables kubelet service

### networking
Applies network fixes:
- Disables TX checksum offload for Calico VXLAN
- Creates systemd service for network fixes

## Configuration

### Ansible Vault (Secrets Management)

1. Copy vault example:
```bash
cp group_vars/vault.yml.example group_vars/vault.yml
```

2. Edit vault file:
```bash
ansible-vault edit group_vars/vault.yml
```

3. Add vault password when running playbooks:
```bash
ansible-playbook -i hosts.ini playbooks/01-prepare-nodes.yml --ask-vault-pass
```

### Custom Variables

Edit `group_vars/all.yml` (or better yet, update Terraform variables which auto-generate this file):
- `kubernetes_version`: Kubernetes version to install
- `calico_version`: Calico CNI version
- `pod_network_cidr`: Pod network CIDR
- `desired_dns_servers`: DNS servers for cluster
- `metallb_ip_range`: IP range for MetalLB

## Common Tasks

### Verify Inventory
```bash
ansible-inventory -i hosts.ini --list
```

### Test Connectivity
```bash
ansible all -i hosts.ini -m ping
```

### Check Syntax
```bash
ansible-playbook --syntax-check playbooks/*.yml
```

### Dry Run
```bash
ansible-playbook -i hosts.ini playbooks/01-prepare-nodes.yml --check
```

### Run Specific Role
```bash
ansible-playbook -i hosts.ini playbooks/01-prepare-nodes.yml --tags firewall
```

## Troubleshooting

### SSH Key Issues
```bash
# Test SSH access
ansible all -i hosts.ini -m ping --private-key ~/.ssh/id_rsa

# Add SSH key to known_hosts
ssh-keyscan <node-ip> >> ~/.ssh/known_hosts
```

### Privilege Escalation
```bash
# Use sudo password
ansible-playbook -i hosts.ini playbooks/01-prepare-nodes.yml --ask-become-pass
```

### View Ansible Logs
```bash
tail -f ansible.log
```

### Debug Mode
```bash
ansible-playbook -i hosts.ini playbooks/01-prepare-nodes.yml -vvv
```

## Cleanup

To reset the cluster:
```bash
ansible-playbook -i hosts.ini playbooks/999-cleanup.yml
```

**Warning**: This will destroy the cluster and remove all Kubernetes components!
