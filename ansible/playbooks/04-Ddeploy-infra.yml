---
# ============================================================================
# DEPLOY INFRASTRUCTURE SERVICES
# ============================================================================
# This playbook deploys infrastructure services and add-ons to the cluster.
# Services are deployed in phases to respect dependencies.
#
# Deployment phases:
#   1. Base infrastructure (parallel): metric-server, metallb, cert-manager
#   2. Gateway API CRDs: Required before Istio
#   3. Service mesh: istio, default-gateways
#   4. Storage provisioner: nfs-provisioner
#   5. Object storage: seaweedfs (requires NFS)
#   6. Secrets management: vault (requires SeaweedFS)
#
# Prerequisites:
#   - Cluster fully operational (03-Join-worker-nodes.yml completed)
#   - kubectl access to cluster
#   - Python virtual environment with Kubernetes libraries
#
# Usage:
#   ansible-playbook playbooks/04-Ddeploy-infra.yml
# ============================================================================

# Base infrastructure - no dependencies
- name: Deploy base infrastructure
  hosts: localhost
  connection: local
  become: false
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/../../.venv/bin/python"
  roles:
    - metric-server
    - metallb
    - cert-manager
    - argocd
    - external-secrets

# Network layer - Gateway API must be before Istio
- name: Deploy Gateway API CRDs
  hosts: localhost
  connection: local
  become: false
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/../../.venv/bin/python"
  roles:
    - gateway-api

- name: Deploy Istio and gateways
  hosts: localhost
  connection: local
  become: false
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/../../.venv/bin/python"
  roles:
    - istio
    - default-gateways
    - envoy-filters

# Storage layer - sequential dependencies: NFS → SeaweedFS → Vault
- name: Deploy NFS provisioner
  hosts: localhost
  connection: local
  become: false
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/../../.venv/bin/python"
  roles:
    - nfs-provisioner

- name: Deploy SeaweedFS (requires NFS)
  hosts: localhost
  connection: local
  become: false
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/../../.venv/bin/python"
  roles:
    - seaweedfs

- name: Deploy Vault (requires SeaweedFS)
  hosts: localhost
  connection: local
  become: false
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/../../.venv/bin/python"
  roles:
    - vault
