---
# ============================================================================
# DEPLOY METALLB
# ============================================================================
# This playbook deploys MetalLB for LoadBalancer services on the Kubernetes cluster.
#
# Steps:
#   1. Create MetalLB namespace
#   2. Install MetalLB manifests
#   3. Configure IPAddressPool
#   4. Configure L2Advertisement
#
# Prerequisites:
#   - Kubernetes cluster must be initialized (initialize-control-plane.yml)
#   - Worker nodes must be joined (join-worker-nodes.yml)
#   - kubectl access must be configured
#
# Post-installation:
#   - LoadBalancer services can be created and will get IPs from the configured range
#
# Usage:
#   ansible-playbook -i hosts.ini playbooks/deploy-metallb.yml
# ============================================================================

- name: Bootstrap MetalLB
  hosts: controlplane
  become: false  # Run as 'danny' so it uses ~/.kube/config

  tasks:
    - name: Ensure MetalLB namespace exists
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: metallb-system
        state: present

    - name: Apply MetalLB manifests
      kubernetes.core.k8s:
        state: present
        src: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml"

    - name: Configure MetalLB IPAddressPool
      kubernetes.core.k8s:
        definition:
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            namespace: metallb-system
            name: metallb-ip-pool
          spec:
            addresses:
              - "{{ metallb_ip_range }}"
        state: present

    - name: Configure MetalLB L2Advertisement
      kubernetes.core.k8s:
        definition:
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            namespace: metallb-system
            name: metallb-l2-advertisement
          spec:
            ipAddressPools:
              - metallb-ip-pool
        state: present
