---
# ============================================================================
# DEPLOY ARGOCD
# ============================================================================
# This playbook installs ArgoCD on the Kubernetes cluster and configures
# the app-of-apps pattern for GitOps.
#
# Steps:
#   1. Install ArgoCD in argocd namespace
#   2. Wait for ArgoCD server to be ready
#   3. Register Git repository credentials
#
# Prerequisites:
#   - Kubernetes cluster must be initialized (initialize-control-plane.yml)
#   - Worker nodes must be joined (join-worker-nodes.yml)
#   - MetalLB must be deployed (deploy-metallb.yml)
#   - kubectl access must be configured
#
# Post-installation:
#   - Get admin password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
#   - Port forward: kubectl port-forward svc/argocd-server -n argocd 8080:443
#
# Usage:
#   ansible-playbook -i hosts.ini playbooks/deploy-argocd.yml
# ============================================================================

- name: Bootstrap ArgoCD
  hosts: controlplane
  become: false  # Run as 'danny' so it uses ~/.kube/config
  vars:
    git_org_url: "git@github.com:danyalahmed/technologylab.git"

  tasks:
    - name: Create argocd namespace
      kubernetes.core.k8s:
        name: argocd
        kind: Namespace
        state: present

    - name: Install ArgoCD Manifests
      kubernetes.core.k8s:
        namespace: argocd
        src: "https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml"
        state: present

    - name: Wait for ArgoCD Server to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        name: argocd-server
        namespace: argocd
      register: argocd_status
      until: argocd_status.resources[0].status.readyReplicas | default(0) > 0
      retries: 20
      delay: 10
    - name: Register Private SSH Key for Git Repos
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: private-git-creds
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repository
          stringData:
            type: git
            url: "{{ git_org_url }}"
            sshPrivateKey: "{{ lookup('file', ansible_ssh_private_key_file) }}"
    - name: Deploy ArgoCD Projects
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: projects-app
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: "{{ git_org_url }}"
              targetRevision: HEAD
              path: argocd/projects
            destination:
              server: https://kubernetes.default.svc
              namespace: argocd
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
    - name: Deploy App of Apps Application
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: root-app
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: "{{ git_org_url }}"
              targetRevision: HEAD
              path: argocd/apps
            destination:
              server: https://kubernetes.default.svc
              namespace: argocd
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
