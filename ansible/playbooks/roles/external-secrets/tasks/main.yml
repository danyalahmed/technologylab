---
- name: Add external-secrets Helm Repo
  delegate_to: localhost
  kubernetes.core.helm_repository:
    name: external-secrets
    repo_url: "https://charts.external-secrets.io"

- name: Create external-secrets Namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: external-secrets
- name: Deploy external-secrets via Helm
  delegate_to: localhost
  kubernetes.core.helm:
    name: external-secrets
    chart_ref: external-secrets/external-secrets
    chart_version: "{{ external_secrets_version }}"
    release_namespace: external-secrets
    values:
      installCRDs: true

- name: Wait for external-secrets to be ready
  kubernetes.core.k8s_info:
    kind: Deployment
    name: external-secrets
    namespace: external-secrets
  register: external_secrets_status
  until:
    - external_secrets_status.resources | length > 0
    - external_secrets_status.resources[0].status.readyReplicas is defined
    - external_secrets_status.resources[0].status.readyReplicas | int > 0
  retries: 30
  delay: 10

- name: Create SecretStore for Vault
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: external-secrets.io/v1
      kind: ClusterSecretStore
      metadata:
        name: vault-secret-store
        namespace: external-secrets
      spec:
        provider:
          vault:
            server: http://vault.vault.svc.cluster.local:8200
            path: kv
            auth:
              kubernetes:
                mountPath: "kubernetes"
                role: "eso-role"
                serviceAccountRef:
                  name: "external-secrets"
                  namespace: "external-secrets"
                  audiences:
                    - "vault"

# Note: vault auth needs to be setup
