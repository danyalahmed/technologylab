# Kubernetes on Proxmox

Fully automated Kubernetes cluster deployment using Terraform and Ansible.

## Structure

```
terraform/          # Infrastructure (VMs)
  â”œâ”€â”€ versions.tf   # â­ Update ALL versions here (single source of truth)
  â”œâ”€â”€ main.tf       # Auto-runs Ansible after VM creation
  â””â”€â”€ modules/

ansible/           # Configuration (auto-generated & auto-executed)
  â”œâ”€â”€ playbooks/
  â”‚   â”œâ”€â”€ prepare-nodes.yml      # Auto-run by Terraform
  â”‚   â””â”€â”€ kubeadm-init.yml       # Auto-run by Terraform
  â”œâ”€â”€ group_vars/
  â”‚   â””â”€â”€ all.yml                # Auto-generated by Terraform
  â””â”€â”€ hosts.ini                  # Auto-generated by Terraform
```

## Quick Start

1. **Configure**
   ```bash
   cd terraform
   cp terraform.auto.tfvars.example terraform.auto.tfvars
   # Edit with your values
   ```

2. **Deploy Everything (One Command!)**
   ```bash
   terraform init
   terraform apply
   ```
   
   This automatically:
   - Creates VMs on Proxmox
   - Generates Ansible inventory and variables
   - Prepares nodes (installs Docker, Kubernetes, etc.)
   - Initializes Kubernetes cluster with Calico CNI
   - Joins worker nodes

3. **Verify Cluster**
   ```bash
   # SSH to control plane
   ssh user@controlplane-ip
   kubectl get nodes
   kubectl get pods --all-namespaces
   ```

That's it! ðŸŽ‰

## Configuration Options

In `terraform.auto.tfvars`:

```hcl
# Disable automatic Ansible execution (run manually instead)
auto_run_ansible = false

# Custom SSH key path
ansible_ssh_key_path = "~/.ssh/custom_key"

# Sudo password (or leave empty to be prompted)
sudo_password = "your-password"
```

## Manual Ansible Execution

If you set `auto_run_ansible = false`, run Ansible manually:

```bash
cd ansible

# Prepare nodes
ansible-playbook -i hosts.ini playbooks/prepare-nodes.yml --ask-become-pass

# Initialize cluster
ansible-playbook -i hosts.ini playbooks/kubeadm-init.yml --ask-become-pass
```

## Upgrading

All versions are in ONE place: `terraform/versions.tf`

To upgrade Kubernetes from v1.35 to v1.36:
1. Edit `terraform/versions.tf` â†’ change `kubernetes_version = "v1.36"`
2. Run: `terraform apply`

Terraform automatically updates Ansible variables and re-runs playbooks with new versions.

## Current Versions

- Kubernetes: v1.35
- Calico: v3.31.3
- Ubuntu: 25.10
- Terraform: >= 1.14

**Note**: All versions are managed in `terraform/versions.tf`. Terraform auto-generates `ansible/group_vars/all.yml` on every apply.

## Requirements

- Terraform >= 1.14
- Ansible >= 2.9
- Proxmox VE
- SSH access to nodes
