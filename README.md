# Kubernetes on Proxmox

Fully automated Kubernetes cluster deployment using Terraform and Ansible.

## Structure

```
terraform/          # Infrastructure (VMs)
  â”œâ”€â”€ versions.tf   # â­ Update ALL versions here (single source of truth)
  â”œâ”€â”€ main.tf       # Auto-runs Ansible after VM creation
  â””â”€â”€ modules/

ansible/           # Configuration (auto-generated & auto-executed)
  â”œâ”€â”€ playbooks/
  â”‚   â”œâ”€â”€ prepare-nodes.yml      # Auto-run by Terraform
  â”‚   â””â”€â”€ kubeadm-init.yml       # Auto-run by Terraform
  â”œâ”€â”€ group_vars/
  â”‚   â””â”€â”€ all.yml                # Auto-generated by Terraform
  â””â”€â”€ hosts.ini                  # Auto-generated by Terraform
```

## Quick Start

1. **Configure**
   ```bash
   cd terraform
   cp terraform.auto.tfvars.example terraform.auto.tfvars
   # Edit with your values
   ```

2. **Deploy Everything (One Command!)**
   ```bash
   terraform init
   terraform apply
   ```
   
   This automatically:
   - Creates VMs on Proxmox
   - Generates Ansible inventory and variables
   - Prepares nodes (installs Docker, Kubernetes, etc.)
   - Initializes Kubernetes cluster with Calico CNI
   - Joins worker nodes

3. **Verify Cluster**
   ```bash
   # SSH to control plane
   ssh user@controlplane-ip
   kubectl get nodes
   kubectl get pods --all-namespaces
   ```

That's it! ðŸŽ‰

## Configuration Options

In `terraform.auto.tfvars`:

```hcl
# Disable automatic Ansible execution (run manually instead)
auto_run_ansible = false

# Custom SSH key path
ansible_ssh_key_path = "~/.ssh/custom_key"

# Sudo password (or leave empty to be prompted)
sudo_password = "your-password"
```

## Manual Ansible Execution

If you set `auto_run_ansible = false`, run Ansible manually:

```bash
cd ansible

# Prepare nodes
ansible-playbook -i hosts.ini playbooks/prepare-nodes.yml --ask-become-pass

# Initialize cluster
ansible-playbook -i hosts.ini playbooks/kubeadm-init.yml --ask-become-pass
```

## Access Headlamp UI (Port-forward + ServiceAccount token) ðŸ”

Use the steps below to port-forward the Headlamp UI (service `svc/kubernetes-dashboard-headlamp`) and log in using a short-lived ServiceAccount token bound to `cluster-admin`. Replace `NAMESPACE` with the namespace where Headlamp is deployed (e.g., `kubernetes-dashboard`).

1. Create a ServiceAccount and ClusterRoleBinding:

```bash
# Create ServiceAccount
kubectl -n kubernetes-dashboard create serviceaccount headlamp-admin

# Bind the ServiceAccount to cluster-admin
kubectl create clusterrolebinding headlamp-admin-binding \
  --clusterrole=cluster-admin \
  --serviceaccount=kubernetes-dashboard:headlamp-admin
```

2. Retrieve a token for the ServiceAccount (recommended on Kubernetes >=1.24):

```bash
kubectl -n kubernetes-dashboard create token headlamp-admin
```

Fallback (older clusters):

```bash
SECRET=$(kubectl -n kubernetes-dashboard get sa headlamp-admin -o jsonpath='{.secrets[0].name}')
kubectl -n kubernetes-dashboard get secret $SECRET -o go-template='{{.data.token | base64decode}}'
```

3. Port-forward the Headlamp service locally and open your browser:

```bash
kubectl -n kubernetes-dashboard port-forward svc/kubernetes-dashboard-headlamp 8080:80
# Then open: http://localhost:8080
```

4. On the Headlamp login screen choose "Token" and paste the token from step 2.

Security notes:

- Binding `cluster-admin` grants full cluster privileges â€” remove the `ClusterRoleBinding` when finished:

```bash
kubectl delete clusterrolebinding headlamp-admin-binding
kubectl -n kubernetes-dashboard delete sa headlamp-admin
```

- Prefer short-lived tokens or OIDC for production environments whenever possible.


## Upgrading

All versions are in ONE place: `terraform/versions.tf`

To upgrade Kubernetes from v1.35 to v1.36:
1. Edit `terraform/versions.tf` â†’ change `kubernetes_version = "v1.36"`
2. Run: `terraform apply`

Terraform automatically updates Ansible variables and re-runs playbooks with new versions.

## Current Versions

- Kubernetes: v1.35
- Calico: v3.31.3
- Ubuntu: 25.10
- Terraform: >= 1.14

**Note**: All versions are managed in `terraform/versions.tf`. Terraform auto-generates `ansible/group_vars/all.yml` on every apply.

## Requirements

- Terraform >= 1.14
- Ansible >= 2.9
- Proxmox VE
- SSH access to nodes
